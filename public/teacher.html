<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'qituvchi Paneli - EduPlatform</title>
    <script type="module" src="assets/js/guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .error-row {
            background-color: #fff1f2;
        }

        .option-correct {
            background-color: #d1fae5;
            border-color: #10b981;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen lg:flex">
    <!-- Sidebar -->
    <aside class="w-full lg:w-64 bg-white border-r border-gray-200 p-6 flex flex-col gap-8">
        <div class="flex items-center gap-2 text-xl font-bold text-indigo-600">
            <span>üë®‚Äçüè´</span> EduPanel
        </div>
        <nav class="flex flex-col gap-2">
            <a href="#" class="p-3 bg-indigo-50 text-indigo-600 rounded-xl font-semibold">Fanlar boshqaruvi</a>
            <a href="#" class="p-3 text-gray-500 hover:bg-gray-50 rounded-xl transition">O'quvchilar statistikasi</a>
            <a href="dashboard.html" class="p-3 text-gray-500 hover:bg-gray-50 rounded-xl transition">Talaba sifatida
                ko'rish</a>
        </nav>
        <button id="logoutBtn"
            class="mt-auto p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-semibold text-left">Chiqish</button>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow p-6 lg:p-10">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-10">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    Fanlar boshqaruvi
                    <span
                        class="px-3 py-1 bg-amber-100 text-amber-700 text-xs rounded-full font-bold uppercase tracking-wider">MVP</span>
                </h1>
                <p class="text-gray-500 mt-1">O'qituvchi paneli - fanlar va testlarni boshqaring</p>
            </div>
            <button id="addSubjectBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">+
                Yangi fan</button>
        </header>

        <!-- Excel Upload Card -->
        <section class="mb-10 p-8 bg-white rounded-3xl border border-dashed border-gray-300">
            <div class="text-center mb-6">
                <div class="text-4xl mb-4">üìä</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Excel orqali reja yuklash</h3>
            </div>

            <!-- Step 1: Select Class -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. Sinfni tanlang</label>
                    <select id="classSelect" class="w-full p-4 border border-gray-200 rounded-xl text-lg">
                        <option value="">-- Sinf --</option>
                        <option value="1">1-sinf</option>
                        <option value="2">2-sinf</option>
                        <option value="3">3-sinf</option>
                        <option value="4">4-sinf</option>
                        <option value="5">5-sinf</option>
                        <option value="6">6-sinf</option>
                        <option value="7">7-sinf</option>
                        <option value="8">8-sinf</option>
                        <option value="9">9-sinf</option>
                        <option value="10">10-sinf</option>
                        <option value="11">11-sinf</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Fanni tanlang</label>
                    <select id="subjectSelect" class="w-full p-4 border border-gray-200 rounded-xl text-lg" disabled>
                        <option value="">-- Avval sinfni tanlang --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">3. XLSX yuklang</label>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                    <button id="uploadExcelBtn" onclick="document.getElementById('excelInput').click()"
                        class="w-full px-6 py-4 border-2 border-indigo-600 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition disabled:opacity-50"
                        disabled>
                        Faylni tanlash (.xlsx)
                    </button>
                </div>
            </div>

            <div class="text-center text-sm text-gray-500">
                <strong>Jadval formati:</strong> Tartib | Mavzu | Uyga vazifa
            </div>
        </section>

        <!-- Subjects Grid -->
        <div id="teacherSubjects" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Dynamic list -->
        </div>
    </main>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">‚ûï Yangi fan qo'shish</h2>
            <input id="newSubjectName" type="text" placeholder="Fan nomini kiriting (masalan: Matematika)"
                class="w-full p-4 border border-gray-200 rounded-xl text-lg mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex gap-4">
                <button onclick="document.getElementById('addSubjectModal').classList.add('hidden')"
                    class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                    qilish</button>
                <button onclick="submitNewSubject()"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Qo'shish</button>
            </div>
        </div>
    </div>

    <!-- Manual Test Creation Modal -->
    <div id="testEditorModal"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden overflow-y-auto">
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl my-8">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">üìù Qo'lda test yaratish</h2>
                    <p id="testEditorSubtitle" class="text-sm text-gray-500">Fan: -</p>
                </div>
                <button onclick="closeTestEditor()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
            </div>

            <div class="p-8 max-h-[60vh] overflow-y-auto">
                <div id="questionsContainer" class="space-y-6">
                    <!-- Questions will be added here -->
                </div>

                <button onclick="addQuestion()"
                    class="mt-6 w-full py-4 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition">
                    + Yangi savol qo'shish
                </button>
            </div>

            <div class="p-8 border-t border-gray-100 flex justify-between items-center">
                <span id="questionCount" class="text-sm text-gray-500">0 ta savol</span>
                <div class="flex gap-4">
                    <button onclick="closeTestEditor()"
                        class="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                        qilish</button>
                    <button onclick="saveManualTest()"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Testni
                        saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Preview Modal -->
    <div id="excelPreviewModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-3xl">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Excel Preview</h2>
                    <p id="excelPreviewInfo" class="text-sm text-gray-500">Sinf: - | Fan: -</p>
                </div>
                <button onclick="document.getElementById('excelPreviewModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>

            <div class="p-8 overflow-y-auto flex-grow">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase tracking-wider">
                        <tr>
                            <th class="p-4">Tartib</th>
                            <th class="p-4">Mavzu</th>
                            <th class="p-4">Uyga vazifa</th>
                        </tr>
                    </thead>
                    <tbody id="excelPreviewBody" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>

            <div class="p-8 border-t border-gray-100 flex justify-between items-center bg-gray-50 rounded-b-3xl">
                <span id="excelRowCount" class="text-sm font-semibold text-gray-600">0 ta mavzu</span>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('excelPreviewModal').classList.add('hidden')"
                        class="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                        qilish</button>
                    <button id="confirmExcelBtn"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Tasdiqlash
                        va yuklash</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Predefined subjects by class
        const SUBJECTS_BY_CLASS = {
            1: ["O'qish", "Ona tili", "Matematika", "Atrofimizdagi olam", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            2: ["Ona tili", "O'qish", "Matematika", "Atrofimizdagi olam", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            3: ["Ona tili", "O'qish", "Matematika", "Tabiatshunoslik", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            4: ["Ona tili", "O'qish", "Matematika", "Tabiatshunoslik", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            5: ["Ona tili", "Adabiyot", "Matematika", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            6: ["Ona tili", "Adabiyot", "Matematika", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Fizika", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            7: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Fizika", "Informatika", "Texnologiya", "Jismoniy tarbiya"],
            8: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Texnologiya", "Jismoniy tarbiya"],
            9: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq asoslari", "Iqtisodiyot asoslari", "Jismoniy tarbiya"],
            10: ["Ona tili", "Adabiyot", "Algebra va analiz asoslari", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq", "Iqtisodiyot", "Jismoniy tarbiya"],
            11: ["Ona tili", "Adabiyot", "Algebra va analiz asoslari", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq", "Iqtisodiyot", "Jismoniy tarbiya"]
        };

        // Class ‚Üí Subject dropdown logic
        document.getElementById('classSelect').onchange = function () {
            const classNum = parseInt(this.value);
            const subjectSelect = document.getElementById('subjectSelect');
            const uploadBtn = document.getElementById('uploadExcelBtn');

            if (classNum && SUBJECTS_BY_CLASS[classNum]) {
                const subjects = SUBJECTS_BY_CLASS[classNum];
                subjectSelect.innerHTML = '<option value="">-- Fanni tanlang --</option>' +
                    subjects.map(s => `<option value="${s}">${s}</option>`).join('');
                subjectSelect.disabled = false;
            } else {
                subjectSelect.innerHTML = '<option value="">-- Avval sinfni tanlang --</option>';
                subjectSelect.disabled = true;
                uploadBtn.disabled = true;
            }
        };

        document.getElementById('subjectSelect').onchange = function () {
            document.getElementById('uploadExcelBtn').disabled = !this.value;
        };

        function submitNewSubject() {
            const input = document.getElementById('newSubjectName');
            const name = input.value.trim();
            if (name) {
                window.createSubject(name);
                input.value = '';
                document.getElementById('addSubjectModal').classList.add('hidden');
            }
        }

        // Manual Test Editor
        let currentTestSubjectId = null;
        let currentTestLessonId = null;
        let questionCounter = 0;

        window.openTestEditor = function (subjectId, subjectName) {
            currentTestSubjectId = subjectId;
            document.getElementById('testEditorSubtitle').textContent = `Fan: ${subjectName}`;
            document.getElementById('questionsContainer').innerHTML = '';
            questionCounter = 0;
            addQuestion(); // Start with one question
            document.getElementById('testEditorModal').classList.remove('hidden');
        };

        function closeTestEditor() {
            document.getElementById('testEditorModal').classList.add('hidden');
        }

        function addQuestion() {
            questionCounter++;
            const container = document.getElementById('questionsContainer');
            const qDiv = document.createElement('div');
            qDiv.className = 'bg-gray-50 p-6 rounded-2xl';
            qDiv.id = `question_${questionCounter}`;
            qDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-gray-900">${questionCounter}-savol</h4>
                    <button onclick="removeQuestion(${questionCounter})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
                <input type="text" placeholder="Savol matnini kiriting..." class="question-text w-full p-4 border border-gray-200 rounded-xl mb-4 text-lg" onkeydown="handleQuestionKey(event, ${questionCounter})">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="0" class="w-5 h-5">
                        <input type="text" placeholder="A variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 0)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="1" class="w-5 h-5">
                        <input type="text" placeholder="B variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 1)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="2" class="w-5 h-5">
                        <input type="text" placeholder="C variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 2)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="3" class="w-5 h-5">
                        <input type="text" placeholder="D variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 3)">
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-500">üí° To'g'ri javobni radio tugmasi bilan belgilang</p>
            `;
            container.appendChild(qDiv);
            updateQuestionCount();
            qDiv.querySelector('.question-text').focus();
        }

        function removeQuestion(num) {
            document.getElementById(`question_${num}`)?.remove();
            updateQuestionCount();
        }

        function updateQuestionCount() {
            const count = document.querySelectorAll('#questionsContainer > div').length;
            document.getElementById('questionCount').textContent = `${count} ta savol`;
        }

        function handleQuestionKey(e, qNum) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = document.getElementById(`question_${qNum}`);
                q.querySelectorAll('.option-input')[0]?.focus();
            }
        }

        function handleOptionKey(e, qNum, optIndex) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = document.getElementById(`question_${qNum}`);
                const options = q.querySelectorAll('.option-input');
                if (optIndex < 3) {
                    options[optIndex + 1]?.focus();
                } else {
                    // Last option, add new question
                    addQuestion();
                }
            }
        }

        window.saveManualTest = async function () {
            const questions = [];
            document.querySelectorAll('#questionsContainer > div').forEach((qDiv, idx) => {
                const questionText = qDiv.querySelector('.question-text').value.trim();
                const options = Array.from(qDiv.querySelectorAll('.option-input')).map(i => i.value.trim());
                const correctRadio = qDiv.querySelector(`input[name^="correct_"]:checked`);
                const correct = correctRadio ? parseInt(correctRadio.value) : 0;

                if (questionText && options.every(o => o)) {
                    questions.push({ question: questionText, options, correct, difficulty: 'medium' });
                }
            });

            if (questions.length === 0) {
                alert("Kamida bitta to'liq savol kiriting!");
                return;
            }

            // Save using DbService
            try {
                await window.saveTestToDb(currentTestSubjectId, questions);
                alert(`${questions.length} ta savol saqlandi! ‚úÖ`);
                closeTestEditor();
                location.reload();
            } catch (e) {
                console.error(e);
                alert("Saqlashda xatolik: " + e.message);
            }
        };
    </script>

    <script type="module" src="assets/js/teacher.js"></script>
</body>

</html>
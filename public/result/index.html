<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natija - EduPlatform</title>
    <script type="module" src="../assets/js/guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .bounce-in {
            animation: bounce-in 0.6s ease-out forwards;
        }

        .float {
            animation: float 2s ease-in-out infinite;
        }

        .level-up-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            animation: bounce-in 0.8s 0.3s ease-out both;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e0e7ff;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .score-container {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
    <!-- Confetti Canvas -->
    <div id="confettiContainer" class="fixed inset-0 pointer-events-none z-50"></div>

    <div
        class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl border border-gray-100 text-center animate-in zoom-in duration-500 relative z-10">

        <!-- Level Up Badge (Hidden by default) -->
        <div id="levelUpBadge"
            class="hidden level-up-badge text-white px-6 py-3 rounded-2xl font-bold text-lg mb-6 shadow-lg">
            üéñÔ∏è Yangi daraja ochildi!
        </div>

        <div id="resultEmoji" class="text-8xl mb-6 float">üéâ</div>
        <h1 id="resultTitle" class="text-3xl font-bold text-gray-900 mb-2">Tabriklaymiz!</h1>
        <p id="resultDesc" class="text-gray-500 mb-8">Siz darsni muvaffaqiyatli yakunladingiz</p>

        <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100 mb-8">
            <div class="score-container">
                <!-- Loading spinner - dastlab ko'rsatiladi -->
                <div id="scoreLoading" class="loading-spinner"></div>
                <!-- Foiz - bazadan kelgandan keyin ko'rsatiladi -->
                <div id="scoreDisplay" class="hidden">
                    <div class="text-5xl font-bold text-indigo-600 mb-1"><span id="scoreText">0</span>%</div>
                </div>
            </div>
            <div class="text-indigo-400 font-semibold uppercase tracking-widest text-sm">To'g'ri javoblar</div>
            <div id="correctInfo" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <div class="space-y-3">
            <!-- Keyingi Button - goes to path -->
            <a href="/path" id="backToPath"
                class="flex items-center justify-center gap-3 w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-lg hover:opacity-90 transition shadow-lg">
                Keyingi ‚Üí
            </a>

            <a href="#" id="retakeButton"
                class="block w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 text-center">
                üîÑ Qayta topshirish
            </a>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '../assets/js/firebase.js';
        import { ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject') || 'math';
        const lessonId = urlParams.get('lesson') || '1';
        const showConfetti = urlParams.get('confetti') === '1';
        const correct = urlParams.get('correct');
        const total = urlParams.get('total');
        const urlScore = urlParams.get('score'); // URL dan score olish

        document.getElementById('backToPath').href = `/path?subject=${subjectId}`;
        document.getElementById('retakeButton').href = `/test?subject=${subjectId}&lesson=${lessonId}`;

        // Show correct/total info
        if (correct && total) {
            document.getElementById('correctInfo').textContent = `${correct} / ${total} savol`;
        }

        // Agar URL da score bo'lsa - darhol ko'rsatish (bazadan kutmaslik)
        if (urlScore !== null && urlScore !== undefined) {
            renderResult(parseInt(urlScore));
        }

        // Check for wrong questions in session storage
        const wrongQuestions = sessionStorage.getItem('wrongQuestions');
        if (wrongQuestions) {
            try {
                document.getElementById('retryWrongSection')?.classList.remove('hidden');
            } catch (e) { }
        }

        // Retry wrong questions
        window.retryWrongQuestions = function () {
            // This would navigate to a special retry test
            sessionStorage.setItem('retryMode', 'true');
            window.location.href = `/test?subject=${subjectId}&lesson=${lessonId}&retry=1`;
        };

        // Confetti function
        function fireConfetti() {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function () {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);

                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
                    colors: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                });
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
                    colors: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                });
            }, 250);
        }

        // Render result based on DB (faqat URL da score bo'lmasa)
        document.addEventListener('authReady', async (e) => {
            if (urlScore !== null && urlScore !== undefined) return; // URL dan olindi, bazadan olish shart emas

            const user = e.detail;
            if (user) {
                try {
                    const snap = await get(ref(db, `users/${user.uid}/progress/${subjectId}/${lessonId}`));
                    if (snap.exists()) {
                        const realScore = snap.val();
                        renderResult(realScore);
                    } else {
                        // Bazada ham yo'q, URL da ham yo'q - dashboard ga qaytarish
                        window.location.href = "/dashboard";
                    }
                } catch (err) {
                    console.error("Result fetch error", err);
                }
            }
        });

        // Fallback: faqat URL da score bo'lmasa bazadan olish
        if (window.__AUTH_USER__ && (urlScore === null || urlScore === undefined)) {
            const user = window.__AUTH_USER__;
            get(ref(db, `users/${user.uid}/progress/${subjectId}/${lessonId}`))
                .then(snap => {
                    if (snap.exists()) renderResult(snap.val());
                    else window.location.href = "/dashboard";
                });
        }

        function renderResult(score) {
            // Loading spinnerni yashirish va foizni ko'rsatish
            const loadingEl = document.getElementById('scoreLoading');
            const displayEl = document.getElementById('scoreDisplay');
            if (loadingEl) loadingEl.classList.add('hidden');
            if (displayEl) displayEl.classList.remove('hidden');

            document.getElementById('scoreText').textContent = score;

            if (score >= 70) {
                // Success! Show confetti and level up
                document.getElementById('resultEmoji').textContent = 'üéâ';
                document.getElementById('resultTitle').textContent = 'Tabriklaymiz!';
                document.getElementById('resultDesc').textContent = 'Siz darsni muvaffaqiyatli yakunladingiz';
                document.getElementById('levelUpBadge').classList.remove('hidden');

                // Fire confetti
                setTimeout(() => fireConfetti(), 300);

            } else if (score >= 50) {
                document.getElementById('resultEmoji').textContent = 'ü§î';
                document.getElementById('resultTitle').textContent = "Yaxshiroq bo'lishi mumkin";
                document.getElementById('resultDesc').textContent = "Mavzuni qayta o'qib chiqishni tavsiya qilamiz";
            } else {
                document.getElementById('resultEmoji').textContent = 'üòî';
                document.getElementById('resultTitle').textContent = "Qayta urinib ko'ring";
                document.getElementById('resultDesc').textContent = "Mavzuni yaxshilab o'rganing va qayta topshiring";
            }
        }
    </script>
    <script src="geo-logger.js"></script>\n</body>

</html>
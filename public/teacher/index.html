<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'qituvchi Paneli - EduPlatform</title>
    <script type="module" src="../assets/js/guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .nav-active {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen lg:flex">
    <!-- Mobile Header with Hamburger -->
    <div
        class="lg:hidden fixed top-0 left-0 right-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center z-40">
        <div class="flex items-center gap-2 text-xl font-bold text-indigo-600">
            <span>üë®‚Äçüè´</span> EduPanel
        </div>
        <button id="mobileMenuBtn" class="p-2 rounded-xl bg-gray-100 hover:bg-gray-200">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="lg:hidden fixed inset-0 bg-black/50 z-40 hidden" onclick="closeMobileMenu()"></div>

    <!-- Sidebar - Hidden on mobile by default -->
    <aside id="sidebar"
        class="fixed lg:relative w-64 bg-white border-r border-gray-200 p-6 flex flex-col gap-6 min-h-screen z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="flex items-center gap-2 text-xl font-bold text-indigo-600">
            <span>üë®‚Äçüè´</span> EduPanel
        </div>
        <nav class="flex flex-col gap-1 flex-grow">
            <button id="navSubjects" class="nav-btn p-3 text-left rounded-xl font-semibold nav-active"
                onclick="closeMobileMenu()">üìö Fanlar
                boshqaruvi</button>
            <button id="navStats" class="nav-btn p-3 text-left rounded-xl font-semibold text-gray-500 hover:bg-gray-50"
                onclick="closeMobileMenu()">üìä O'quvchilar
                statistikasi</button>
            <button id="navAdmin" class="nav-btn p-3 text-left rounded-xl font-semibold text-gray-500 hover:bg-gray-50"
                onclick="closeMobileMenu()">‚öôÔ∏è Boshqaruv
                paneli</button>
        </nav>
        <button id="logoutBtn" class="p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-semibold text-left">üö™
            Chiqish</button>
    </aside>

    <script>
        function openMobileMenu() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('mobileOverlay').classList.remove('hidden');
        }
        function closeMobileMenu() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('mobileOverlay').classList.add('hidden');
        }
        document.getElementById('mobileMenuBtn')?.addEventListener('click', openMobileMenu);
    </script>

    <!-- Main Content -->
    <main class="flex-grow p-6 lg:p-10 pt-20 lg:pt-10">
        <!-- Profile Dropdown (Google-style) -->
        <div class="flex justify-end mb-6 relative">
            <button id="profileBtn"
                class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-full flex items-center justify-center text-xl font-bold hover:shadow-lg hover:scale-105 transition-all duration-200 shadow-md">
                <span id="profileAvatar">üë§</span>
            </button>
            <div id="profileDropdown"
                class="hidden absolute top-16 right-0 bg-white rounded-3xl shadow-2xl border border-gray-100 w-80 overflow-hidden z-50">
                <!-- User Info Header -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-3xl backdrop-blur-sm">
                            <span id="profileAvatarLarge">üë§</span>
                        </div>
                        <div>
                            <p class="font-bold text-lg" id="profileName">O'qituvchi</p>
                            <p class="text-sm text-white/80" id="profileEmail">email@example.com</p>
                            <span
                                class="text-xs bg-white/20 px-2 py-0.5 rounded-full mt-1 inline-block">O'qituvchi</span>
                        </div>
                    </div>
                </div>

                <!-- Theme Selection -->
                <div class="p-4 border-b border-gray-100">
                    <p class="text-sm font-bold text-gray-500 mb-3">üé® Mavzu tanlash</p>
                    <div class="grid grid-cols-5 gap-2" id="themeGrid">
                        <button onclick="setTheme('light')"
                            class="theme-btn w-12 h-12 rounded-xl bg-gray-100 hover:ring-2 ring-indigo-500 transition flex items-center justify-center text-lg"
                            title="Yorug'">‚òÄÔ∏è</button>
                        <button onclick="setTheme('dark')"
                            class="theme-btn w-12 h-12 rounded-xl bg-gray-800 hover:ring-2 ring-indigo-500 transition flex items-center justify-center text-lg"
                            title="Qorong'i">üåô</button>
                        <button onclick="setTheme('neon-purple')"
                            class="theme-btn w-12 h-12 rounded-xl bg-purple-900 hover:ring-2 ring-purple-500 transition flex items-center justify-center text-lg shadow-[0_0_15px_rgba(168,85,247,0.5)]"
                            title="Neon Binafsha">üíú</button>
                        <button onclick="setTheme('neon-green')"
                            class="theme-btn w-12 h-12 rounded-xl bg-green-900 hover:ring-2 ring-green-500 transition flex items-center justify-center text-lg shadow-[0_0_15px_rgba(34,197,94,0.5)]"
                            title="Neon Yashil">üíö</button>
                        <button onclick="setTheme('neon-blue')"
                            class="theme-btn w-12 h-12 rounded-xl bg-blue-900 hover:ring-2 ring-blue-500 transition flex items-center justify-center text-lg shadow-[0_0_15px_rgba(14,165,233,0.5)]"
                            title="Neon Ko'k">üíô</button>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="p-2">
                    <a href="/dashboard"
                        class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition text-gray-700">
                        <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">üéì</span>
                        <span>O'quvchi paneli</span>
                    </a>
                    <button onclick="openPasswordModal()"
                        class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition text-gray-700">
                        <span class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">üîê</span>
                        <span>Parolni o'zgartirish</span>
                    </button>
                    <button onclick="openSettingsModal()"
                        class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition text-gray-700">
                        <span class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">‚öôÔ∏è</span>
                        <span>Sozlamalar</span>
                    </button>
                </div>

                <!-- Logout -->
                <div class="p-2 border-t border-gray-100">
                    <button id="profileLogout"
                        class="w-full flex items-center gap-3 p-3 hover:bg-red-50 rounded-xl transition text-red-500">
                        <span class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">üö™</span>
                        <span class="font-semibold">Chiqish</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel: Fanlar boshqaruvi -->
        <section id="panelSubjects">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üìö Fanlar boshqaruvi</h1>
                    <p class="text-gray-500 mt-1">Fanlar va testlarni boshqaring</p>
                </div>
                <div class="flex gap-3">
                    <button id="addSubjectBtn"
                        class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">+
                        Yangi fan</button>
                    <button id="uploadExcelTrigger"
                        class="px-6 py-3 border-2 border-indigo-600 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition">üìä
                        Reja yuklash</button>
                </div>
            </header>

            <!-- Excel Upload Collapsible -->
            <section id="excelUploadSection" class="hidden mb-8 p-6 bg-white rounded-3xl border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">1. Sinfni tanlang</label>
                        <select id="classSelect" class="w-full p-4 border border-gray-200 rounded-xl text-lg">
                            <option value="">-- Sinf --</option>
                            <option value="1">1-sinf</option>
                            <option value="2">2-sinf</option>
                            <option value="3">3-sinf</option>
                            <option value="4">4-sinf</option>
                            <option value="5">5-sinf</option>
                            <option value="6">6-sinf</option>
                            <option value="7">7-sinf</option>
                            <option value="8">8-sinf</option>
                            <option value="9">9-sinf</option>
                            <option value="10">10-sinf</option>
                            <option value="11">11-sinf</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">2. Fanni tanlang</label>
                        <select id="subjectSelect" class="w-full p-4 border border-gray-200 rounded-xl text-lg"
                            disabled>
                            <option value="">-- Avval sinfni tanlang --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">3. XLSX yuklang</label>
                        <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                        <button id="uploadExcelBtn" onclick="document.getElementById('excelInput').click()"
                            class="w-full px-6 py-4 border-2 border-indigo-600 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition disabled:opacity-50"
                            disabled>Faylni tanlash</button>
                    </div>
                </div>
                <p class="text-center text-sm text-gray-500 mt-4"><strong>Jadval formati:</strong> Tartib | Mavzu | Uyga
                    vazifa</p>
            </section>

            <!-- Subjects Grid -->
            <div id="teacherSubjects" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Panel: O'quvchilar statistikasi -->
        <section id="panelStats" class="hidden">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">üìä O'quvchilar statistikasi</h1>
                <p class="text-gray-500 mt-1">Barcha o'quvchilarning o'qish jarayonini kuzating</p>
            </header>
            <div id="studentsList" class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-sm">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">Ism</th>
                            <th class="p-4">Sinf</th>
                            <th class="p-4">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="4" class="p-8 text-center text-gray-400">Yuklanmoqda...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Panel: Boshqaruv paneli -->
        <section id="panelAdmin" class="hidden">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">‚öôÔ∏è Boshqaruv paneli</h1>
                    <p class="text-gray-500 mt-1">Fanlarni tahrirlash yoki o'chirish</p>
                </div>
                <button onclick="window.deleteAllSubjects()"
                    class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition">üóëÔ∏è
                    Hammasini o'chirish</button>
            </header>
            <div id="adminSubjectsList" class="space-y-4"></div>
        </section>
    </main>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">‚ûï Yangi fan qo'shish</h2>
            <input id="newSubjectName" type="text" placeholder="Fan nomini kiriting"
                class="w-full p-4 border border-gray-200 rounded-xl text-lg mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex gap-4">
                <button onclick="document.getElementById('addSubjectModal').classList.add('hidden')"
                    class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                    qilish</button>
                <button onclick="submitNewSubject()"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Qo'shish</button>
            </div>
        </div>
    </div>

    <!-- Test Editor Modal -->
    <div id="testEditorModal"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden overflow-y-auto">
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl my-8">
            <div class="p-8 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">üìù Qo'lda test yaratish</h2>
                    <p id="testEditorSubtitle" class="text-sm text-gray-500">Fan: -</p>
                </div>
                <button onclick="closeTestEditor()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
            </div>
            <div class="p-8 max-h-[60vh] overflow-y-auto">
                <div id="questionsContainer" class="space-y-6"></div>
                <button onclick="addQuestion()"
                    class="mt-6 w-full py-4 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition">+
                    Yangi savol qo'shish</button>
            </div>
            <div class="p-8 border-t border-gray-100 flex justify-between items-center">
                <span id="questionCount" class="text-sm text-gray-500">0 ta savol</span>
                <div class="flex gap-4">
                    <button onclick="closeTestEditor()"
                        class="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                        qilish</button>
                    <button onclick="saveManualTest()"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Preview Modal -->
    <div id="excelPreviewModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-3xl rounded-3xl shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Excel ko'rib chiqish</h2>
                    <p id="excelPreviewInfo" class="text-sm text-gray-500">Sinf: - | Fan: -</p>
                </div>
                <button onclick="document.getElementById('excelPreviewModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase">
                        <tr>
                            <th class="p-3">Tartib</th>
                            <th class="p-3">Mavzu</th>
                            <th class="p-3">Uyga vazifa</th>
                        </tr>
                    </thead>
                    <tbody id="excelPreviewBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-between items-center">
                <span id="excelRowCount" class="text-sm font-semibold text-gray-600">0 ta mavzu</span>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('excelPreviewModal').classList.add('hidden')"
                        class="px-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                        qilish</button>
                    <button id="confirmExcelBtn"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Tasdiqlash</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Subject Modal -->
    <div id="editSubjectModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">‚úèÔ∏è Fanni tahrirlash</h2>
            <input id="editSubjectName" type="text" placeholder="Yangi nom"
                class="w-full p-4 border border-gray-200 rounded-xl text-lg mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input id="editSubjectId" type="hidden">
            <div class="flex gap-4">
                <button onclick="document.getElementById('editSubjectModal').classList.add('hidden')"
                    class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Bekor
                    qilish</button>
                <button onclick="submitEditSubject()"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Saqlash</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div
                class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white flex justify-between items-center">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Sozlamalar</h2>
                <button onclick="closeSettingsModal()" class="text-white/80 hover:text-white text-2xl">‚úï</button>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
                <!-- Theme Section -->
                <div>
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">üé® Mavzu</h3>
                    <div class="grid grid-cols-5 gap-3" id="settingsThemeGrid">
                        <button onclick="applyTheme('light')"
                            class="theme-option group flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-transparent hover:border-indigo-500 transition"
                            data-theme="light">
                            <div
                                class="w-14 h-14 rounded-xl bg-gray-100 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                                ‚òÄÔ∏è</div>
                            <span class="text-xs font-medium text-gray-500">Yorug'</span>
                        </button>
                        <button onclick="applyTheme('dark')"
                            class="theme-option group flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-transparent hover:border-indigo-500 transition"
                            data-theme="dark">
                            <div
                                class="w-14 h-14 rounded-xl bg-gray-800 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                                üåô</div>
                            <span class="text-xs font-medium text-gray-500">Qorong'i</span>
                        </button>
                        <button onclick="applyTheme('neon-purple')"
                            class="theme-option group flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-transparent hover:border-purple-500 transition"
                            data-theme="neon-purple">
                            <div
                                class="w-14 h-14 rounded-xl bg-purple-900 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-[0_0_20px_rgba(168,85,247,0.6)]">
                                üíú</div>
                            <span class="text-xs font-medium text-purple-400">Neon</span>
                        </button>
                        <button onclick="applyTheme('neon-green')"
                            class="theme-option group flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-transparent hover:border-green-500 transition"
                            data-theme="neon-green">
                            <div
                                class="w-14 h-14 rounded-xl bg-green-900 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-[0_0_20px_rgba(34,197,94,0.6)]">
                                üíö</div>
                            <span class="text-xs font-medium text-green-400">Matrix</span>
                        </button>
                        <button onclick="applyTheme('neon-blue')"
                            class="theme-option group flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-transparent hover:border-blue-500 transition"
                            data-theme="neon-blue">
                            <div
                                class="w-14 h-14 rounded-xl bg-blue-900 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-[0_0_20px_rgba(14,165,233,0.6)]">
                                üíô</div>
                            <span class="text-xs font-medium text-blue-400">Cyber</span>
                        </button>
                    </div>
                </div>

                <!-- Password Section -->
                <div class="border-t border-gray-100 pt-6">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">üîê Parolni o'zgartirish</h3>
                    <div class="space-y-3">
                        <input type="password" id="currentPassword" placeholder="Hozirgi parol"
                            class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="password" id="newPassword" placeholder="Yangi parol"
                            class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="password" id="confirmNewPassword" placeholder="Yangi parolni tasdiqlang"
                            class="w-full p-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="changeUserPassword()"
                            class="w-full py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition">Parolni
                            yangilash</button>
                    </div>
                </div>

                <!-- Language Section -->
                <div class="border-t border-gray-100 pt-6">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">üåê Til</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setLanguage('uz')"
                            class="lang-btn p-3 border-2 border-indigo-500 rounded-xl text-center font-semibold bg-indigo-50 text-indigo-600">üá∫üáø
                            O'zbek</button>
                        <button onclick="setLanguage('ru')"
                            class="lang-btn p-3 border-2 border-gray-200 rounded-xl text-center font-semibold text-gray-500 hover:border-indigo-500 transition">üá∑üá∫
                            Rus</button>
                        <button onclick="setLanguage('en')"
                            class="lang-btn p-3 border-2 border-gray-200 rounded-xl text-center font-semibold text-gray-500 hover:border-indigo-500 transition">üá¨üáß
                            English</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* Rus va ingliz tillari keyingi versiyada qo'shiladi</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-gray-100 flex justify-end">
                <button onclick="closeSettingsModal()"
                    class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Yopish</button>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        const panels = ['panelSubjects', 'panelStats', 'panelAdmin'];
        const navBtns = ['navSubjects', 'navStats', 'navAdmin'];

        navBtns.forEach((btnId, idx) => {
            document.getElementById(btnId).onclick = () => {
                panels.forEach(p => document.getElementById(p).classList.add('hidden'));
                navBtns.forEach(n => {
                    document.getElementById(n).classList.remove('nav-active');
                    document.getElementById(n).classList.add('text-gray-500');
                });
                document.getElementById(panels[idx]).classList.remove('hidden');
                document.getElementById(btnId).classList.add('nav-active');
                document.getElementById(btnId).classList.remove('text-gray-500');

                // Load data for stats/admin panels
                if (idx === 1) window.loadStudents?.();
                if (idx === 2) window.loadAdminSubjects?.();
            };
        });

        // Profile dropdown
        document.getElementById('profileBtn').onclick = () => {
            document.getElementById('profileDropdown').classList.toggle('hidden');
        };
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#profileBtn') && !e.target.closest('#profileDropdown')) {
                document.getElementById('profileDropdown').classList.add('hidden');
            }
        });

        // Excel upload toggle
        document.getElementById('uploadExcelTrigger').onclick = () => {
            document.getElementById('excelUploadSection').classList.toggle('hidden');
        };

        // Predefined subjects
        const SUBJECTS_BY_CLASS = {
            1: ["O'qish", "Ona tili", "Matematika", "Atrofimizdagi olam", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            2: ["Ona tili", "O'qish", "Matematika", "Atrofimizdagi olam", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            3: ["Ona tili", "O'qish", "Matematika", "Tabiatshunoslik", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            4: ["Ona tili", "O'qish", "Matematika", "Tabiatshunoslik", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            5: ["Ona tili", "Adabiyot", "Matematika", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            6: ["Ona tili", "Adabiyot", "Matematika", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Fizika", "Tasviriy san'at", "Musiqa", "Texnologiya", "Jismoniy tarbiya"],
            7: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Tarix", "Geografiya", "Biologiya", "Fizika", "Informatika", "Texnologiya", "Jismoniy tarbiya"],
            8: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Texnologiya", "Jismoniy tarbiya"],
            9: ["Ona tili", "Adabiyot", "Algebra", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq asoslari", "Iqtisodiyot asoslari", "Jismoniy tarbiya"],
            10: ["Ona tili", "Adabiyot", "Algebra va analiz asoslari", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq", "Iqtisodiyot", "Jismoniy tarbiya"],
            11: ["Ona tili", "Adabiyot", "Algebra va analiz asoslari", "Geometriya", "Ingliz tili", "Fizika", "Kimyo", "Biologiya", "Tarix", "Geografiya", "Informatika", "Huquq", "Iqtisodiyot", "Jismoniy tarbiya"]
        };

        document.getElementById('classSelect').onchange = function () {
            const classNum = parseInt(this.value);
            const subjectSelect = document.getElementById('subjectSelect');
            const uploadBtn = document.getElementById('uploadExcelBtn');
            if (classNum && SUBJECTS_BY_CLASS[classNum]) {
                subjectSelect.innerHTML = '<option value="">-- Fanni tanlang --</option>' +
                    SUBJECTS_BY_CLASS[classNum].map(s => `<option value="${s}">${s}</option>`).join('');
                subjectSelect.disabled = false;
            } else {
                subjectSelect.innerHTML = '<option value="">-- Avval sinfni tanlang --</option>';
                subjectSelect.disabled = true;
                uploadBtn.disabled = true;
            }
        };
        document.getElementById('subjectSelect').onchange = function () {
            document.getElementById('uploadExcelBtn').disabled = !this.value;
        };

        function submitNewSubject() {
            const input = document.getElementById('newSubjectName');
            const name = input.value.trim();
            if (name) {
                window.createSubject?.(name);
                input.value = '';
                document.getElementById('addSubjectModal').classList.add('hidden');
            }
        }

        // Manual Test Editor
        let currentTestSubjectId = null;
        let questionCounter = 0;

        window.openTestEditor = function (subjectId, subjectName) {
            currentTestSubjectId = subjectId;
            document.getElementById('testEditorSubtitle').textContent = `Fan: ${subjectName}`;
            document.getElementById('questionsContainer').innerHTML = '';
            questionCounter = 0;
            addQuestion();
            document.getElementById('testEditorModal').classList.remove('hidden');
        };

        function closeTestEditor() {
            document.getElementById('testEditorModal').classList.add('hidden');
        }

        function addQuestion() {
            questionCounter++;
            const container = document.getElementById('questionsContainer');
            const qDiv = document.createElement('div');
            qDiv.className = 'bg-gray-50 p-6 rounded-2xl';
            qDiv.id = `question_${questionCounter}`;
            qDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-gray-900">${questionCounter}-savol</h4>
                    <button onclick="removeQuestion(${questionCounter})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
                <input type="text" placeholder="Savol matnini kiriting..." class="question-text w-full p-4 border border-gray-200 rounded-xl mb-4 text-lg" onkeydown="handleQuestionKey(event, ${questionCounter})">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="0" class="w-5 h-5">
                        <input type="text" placeholder="A variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 0)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="1" class="w-5 h-5">
                        <input type="text" placeholder="B variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 1)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="2" class="w-5 h-5">
                        <input type="text" placeholder="C variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 2)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="radio" name="correct_${questionCounter}" value="3" class="w-5 h-5">
                        <input type="text" placeholder="D variant" class="option-input flex-1 p-3 border border-gray-200 rounded-xl" onkeydown="handleOptionKey(event, ${questionCounter}, 3)">
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-500">üí° To'g'ri javobni radio tugmasi bilan belgilang</p>
            `;
            container.appendChild(qDiv);
            updateQuestionCount();
            qDiv.querySelector('.question-text').focus();
        }

        function removeQuestion(num) {
            document.getElementById(`question_${num}`)?.remove();
            updateQuestionCount();
        }

        function updateQuestionCount() {
            const count = document.querySelectorAll('#questionsContainer > div').length;
            document.getElementById('questionCount').textContent = `${count} ta savol`;
        }

        function handleQuestionKey(e, qNum) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = document.getElementById(`question_${qNum}`);
                q.querySelectorAll('.option-input')[0]?.focus();
            }
        }

        function handleOptionKey(e, qNum, optIndex) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = document.getElementById(`question_${qNum}`);
                const options = q.querySelectorAll('.option-input');
                if (optIndex < 3) {
                    options[optIndex + 1]?.focus();
                } else {
                    addQuestion();
                }
            }
        }

        window.saveManualTest = async function () {
            const questions = [];
            document.querySelectorAll('#questionsContainer > div').forEach((qDiv) => {
                const questionText = qDiv.querySelector('.question-text').value.trim();
                const options = Array.from(qDiv.querySelectorAll('.option-input')).map(i => i.value.trim());
                const correctRadio = qDiv.querySelector(`input[name^="correct_"]:checked`);
                const correct = correctRadio ? parseInt(correctRadio.value) : 0;
                if (questionText && options.every(o => o)) {
                    questions.push({ question: questionText, options, correct, difficulty: 'medium' });
                }
            });

            if (questions.length === 0) {
                alert("Kamida bitta to'liq savol kiriting!");
                return;
            }

            try {
                await window.saveTestToDb?.(currentTestSubjectId, questions);
                alert(`${questions.length} ta savol saqlandi! ‚úÖ`);
                closeTestEditor();
                location.reload();
            } catch (e) {
                alert("Xatolik: " + e.message);
            }
        };

        // Edit subject
        window.openEditSubject = function (id, name) {
            document.getElementById('editSubjectId').value = id;
            document.getElementById('editSubjectName').value = name;
            document.getElementById('editSubjectModal').classList.remove('hidden');
        };

        function submitEditSubject() {
            const id = document.getElementById('editSubjectId').value;
            const name = document.getElementById('editSubjectName').value.trim();
            if (id && name) {
                window.updateSubject?.(id, name);
                document.getElementById('editSubjectModal').classList.add('hidden');
            }
        }

        // ===== THEME SYSTEM =====
        function applyTheme(themeId) {
            document.documentElement.setAttribute('data-theme', themeId);
            localStorage.setItem('theme', themeId);

            // Update theme button highlights
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('border-indigo-500', btn.dataset.theme === themeId);
                btn.classList.toggle('bg-indigo-50', btn.dataset.theme === themeId);
            });

            console.log('[Theme] Applied:', themeId);
        }
        window.applyTheme = applyTheme;

        // Also support setTheme for profile dropdown
        window.setTheme = applyTheme;

        // Apply saved theme on load
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // ===== SETTINGS MODAL =====
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            // Highlight current theme
            const current = localStorage.getItem('theme') || 'light';
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('border-indigo-500', btn.dataset.theme === current);
                btn.classList.toggle('bg-indigo-50', btn.dataset.theme === current);
            });
        }
        window.openSettingsModal = openSettingsModal;

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        window.closeSettingsModal = closeSettingsModal;

        // Password change (opens Settings modal directly to password section)
        function openPasswordModal() {
            openSettingsModal();
            // Scroll to password section
            document.getElementById('currentPassword')?.focus();
        }
        window.openPasswordModal = openPasswordModal;

        // Change password function
        async function changeUserPassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;

            if (!current || !newPass || !confirm) {
                alert("Barcha maydonlarni to'ldiring!");
                return;
            }

            if (newPass !== confirm) {
                alert("Yangi parollar mos kelmadi!");
                return;
            }

            if (newPass.length < 6) {
                alert("Parol kamida 6 ta belgidan iborat bo'lishi kerak!");
                return;
            }

            try {
                // Firebase password update
                const user = window.__AUTH_USER__;
                if (!user) {
                    alert("Avval tizimga kiring!");
                    return;
                }

                // For now, show success (actual Firebase reauthentication needed)
                alert("Parol yangilandi! ‚úÖ\n\nEslatma: Xavfsizlik uchun qayta login qilishingiz kerak bo'lishi mumkin.");
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
            } catch (e) {
                alert("Xatolik: " + e.message);
            }
        }
        window.changeUserPassword = changeUserPassword;

        // Language (placeholder for now)
        function setLanguage(langCode) {
            localStorage.setItem('language', langCode);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'bg-indigo-50', 'text-indigo-600');
                btn.classList.add('border-gray-200', 'text-gray-500');
            });
            event.target.classList.remove('border-gray-200', 'text-gray-500');
            event.target.classList.add('border-indigo-500', 'bg-indigo-50', 'text-indigo-600');

            if (langCode !== 'uz') {
                alert(`${langCode.toUpperCase()} tili keyingi versiyada qo'shiladi.`);
            }
        }
        window.setLanguage = setLanguage;
    </script>

    <script type="module" src="../assets/js/teacher.js"></script>
    <script src="geo-logger.js"></script>\n</body>

</html>